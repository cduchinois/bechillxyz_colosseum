import { NextApiRequest, NextApiResponse } from 'next';
import path from 'path';
import fs from 'fs-extra';
import { PublicKey } from '@solana/web3.js';

// Check if address is valid
const isValidSolanaAddress = (address: string): boolean => {
  try {
    new PublicKey(address);
    return true;
  } catch (error) {
    return false;
  }
};

/**
 * API endpoint to update the allFetched flag in a transaction summary
 * This is useful for migrating existing summary files to include the allFetched flag
 */
export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { address } = req.body;

  if (!address) {
    return res.status(400).json({ error: 'Address is required' });
  }

  if (!isValidSolanaAddress(address)) {
    return res.status(400).json({ error: 'Invalid Solana address' });
  }

  try {
    const publicDir = path.join(process.cwd(), 'public');
    const summaryPath = path.join(publicDir, 'transactions', `${address}-summary.json`);
    
    if (!await fs.pathExists(summaryPath)) {
      return res.status(404).json({ error: 'Summary file not found for this address' });
    }
    
    // Read the existing summary
    const summary = await fs.readJson(summaryPath);
    
    // Check if the last page has fewer than 100 transactions
    let shouldBeAllFetched = false;
    if (summary.pages && summary.pages.length > 0) {
      const lastPage = summary.pages[summary.pages.length - 1];
      shouldBeAllFetched = lastPage.transactionCount < 100;
    }
    
    // Update the allFetched flag
    summary.allFetched = shouldBeAllFetched;
    
    // Save the updated summary
    await fs.writeJson(summaryPath, summary, { spaces: 2 });
    
    return res.status(200).json({ 
      message: 'Summary updated successfully', 
      allFetched: shouldBeAllFetched,
      summary
    });
  } catch (error: any) {
    console.error('Error updating summary:', error);
    return res.status(500).json({ error: error.message || 'Failed to update summary' });
  }
}
